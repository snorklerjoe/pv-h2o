{% extends "base.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div class="row">
    <div class="col-md-12">
        <h1>Grapher</h1>
        <p class="text-muted">Visualize historical sensor data.</p>
        
        <div class="card mb-4">
            <div class="card-body">
                <form id="graph-form" class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label for="start-time" class="form-label">Start Time</label>
                        <input type="datetime-local" class="form-control" id="start-time" required>
                    </div>
                    <div class="col-md-2">
                        <label for="end-time" class="form-label">End Time</label>
                        <input type="datetime-local" class="form-control" id="end-time" required>
                    </div>
                    <div class="col-md-2">
                        <label for="smoothing" class="form-label">Smoothing (pts)</label>
                        <input type="number" class="form-control" id="smoothing" value="1" min="1" max="100">
                    </div>
                    <div class="col-md-2">
                        <label for="highlight" class="form-label">Highlight</label>
                        <select class="form-select" id="highlight">
                            <option value="none" selected>None</option>
                            <option value="circuit1">Circuit 1</option>
                            <option value="circuit2">Circuit 2</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Sensors</label>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="sensorDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                Select Sensors
                            </button>
                            <ul class="dropdown-menu w-100" aria-labelledby="sensorDropdown" id="sensor-list">
                                <!-- Populated by JS -->
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">Graph</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <div style="height: 500px;">
                    <canvas id="main-chart"></canvas>
                </div>
                <div class="mt-3 text-end">
                    <button class="btn btn-success" onclick="exportCSV()">Export CSV</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let mainChart;
    let availableSensors = [];

    // Plugin to draw background highlights
    const backgroundPlugin = {
        id: 'backgroundPlugin',
        beforeDraw: (chart) => {
            const highlightMode = document.getElementById('highlight').value;
            if (highlightMode === 'none' || !chart.data.relays) return;

            const ctx = chart.ctx;
            const xAxis = chart.scales.x;
            const yAxis = chart.scales.y;
            const relays = chart.data.relays;
            
            let relayInside, relayOutside;
            if (highlightMode === 'circuit1') {
                relayInside = relays.inside_1;
                relayOutside = relays.outside_1;
            } else {
                relayInside = relays.inside_2;
                relayOutside = relays.outside_2;
            }

            ctx.save();
            
            // We assume the data points are evenly spaced or at least sequential matching the labels
            // Since we are using category axis (labels), we iterate by index
            
            for (let i = 0; i < relayInside.length - 1; i++) {
                // Circuit is ON if both relays are ON (Control + GFCI)
                const isOn = relayInside[i] && relayOutside[i];
                
                ctx.fillStyle = isOn ? 'rgba(25, 135, 84, 0.15)' : 'rgba(220, 53, 69, 0.15)';
                
                // Get x coordinates for the current interval
                // We extend from current point to next point
                const startX = xAxis.getPixelForValue(i);
                const endX = xAxis.getPixelForValue(i+1);
                
                // Fill the vertical slice
                ctx.fillRect(startX, yAxis.top, endX - startX, yAxis.bottom - yAxis.top);
            }
            
            ctx.restore();
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        // Set default times (last 24h)
        const now = new Date();
        const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
        
        // Format for datetime-local input (YYYY-MM-DDTHH:mm)
        const formatDT = (d) => {
            const pad = (n) => n < 10 ? '0' + n : n;
            return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
        };
        
        document.getElementById('end-time').value = formatDT(now);
        document.getElementById('start-time').value = formatDT(yesterday);

        // Load sensors
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                availableSensors = Object.keys(data.sensors).sort();
                const list = document.getElementById('sensor-list');
                availableSensors.forEach(s => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="dropdown-item">
                            <div class="form-check">
                                <input class="form-check-input sensor-check" type="checkbox" value="${s}" id="check-${s}" checked>
                                <label class="form-check-label" for="check-${s}">
                                    ${s}
                                </label>
                            </div>
                        </div>
                    `;
                    list.appendChild(li);
                });
                
                // Initial graph
                updateGraph();
            });

        document.getElementById('graph-form').addEventListener('submit', (e) => {
            e.preventDefault();
            updateGraph();
        });
    });

    function updateGraph() {
        const start = new Date(document.getElementById('start-time').value).toISOString();
        const end = new Date(document.getElementById('end-time').value).toISOString();
        const smoothing = parseInt(document.getElementById('smoothing').value) || 1;
        
        const selectedSensors = Array.from(document.querySelectorAll('.sensor-check:checked')).map(cb => cb.value);
        
        if (selectedSensors.length === 0) {
            alert("Please select at least one sensor.");
            return;
        }

        fetch(`/api/history?start=${start}&end=${end}&sensors=${selectedSensors.join(',')}`)
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('main-chart');
                const timestamps = data.timestamps.map(t => new Date(t).toLocaleString());
                
                const datasets = Object.entries(data.sensors).map(([sensor, values], index) => {
                    // Apply smoothing (Simple Moving Average)
                    let smoothedValues = values;
                    if (smoothing > 1) {
                        smoothedValues = [];
                        for (let i = 0; i < values.length; i++) {
                            let sum = 0;
                            let count = 0;
                            for (let j = 0; j < smoothing; j++) {
                                if (i - j >= 0 && values[i - j] !== null) {
                                    sum += values[i - j];
                                    count++;
                                }
                            }
                            smoothedValues.push(count > 0 ? sum / count : null);
                        }
                    }

                    const colors = [
                        'rgb(255, 99, 132)', 'rgb(54, 162, 235)', 'rgb(255, 206, 86)', 
                        'rgb(75, 192, 192)', 'rgb(153, 102, 255)', 'rgb(255, 159, 64)',
                        'rgb(199, 199, 199)'
                    ];
                    
                    // Use human readable name if available
                    const label = data.sensor_names && data.sensor_names[sensor] ? data.sensor_names[sensor] : sensor;

                    return {
                        label: label,
                        data: smoothedValues,
                        borderColor: colors[index % colors.length],
                        tension: 0.1,
                        pointRadius: 0,
                        borderWidth: 2
                    };
                });

                if (mainChart) {
                    mainChart.destroy();
                }

                mainChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: timestamps,
                        datasets: datasets
                    },
                    plugins: [backgroundPlugin],
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Sensor History'
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    maxTicksLimit: 10
                                }
                            }
                        }
                    }
                });
                
                // Attach relay data to the chart data so the plugin can access it
                mainChart.data.relays = data.relays;
                mainChart.update();
            });
    }

    function exportCSV() {
        const start = new Date(document.getElementById('start-time').value).toISOString();
        const end = new Date(document.getElementById('end-time').value).toISOString();
        const selectedSensors = Array.from(document.querySelectorAll('.sensor-check:checked')).map(cb => cb.value);
        
        if (selectedSensors.length === 0) {
            alert("Please select at least one sensor.");
            return;
        }

        fetch(`/api/history?start=${start}&end=${end}&sensors=${selectedSensors.join(',')}`)
            .then(response => response.json())
            .then(data => {
                let csvContent = "data:text/csv;charset=utf-8,";
                
                // Header
                // Add relay headers
                csvContent += "Timestamp," + Object.keys(data.sensors).join(",") + ",Relay_In_1,Relay_Out_1,Relay_In_2,Relay_Out_2\r\n";
                
                // Rows
                data.timestamps.forEach((ts, index) => {
                    let row = ts;
                    Object.values(data.sensors).forEach(values => {
                        row += "," + (values[index] !== null ? values[index] : "");
                    });
                    
                    // Add relay values
                    if (data.relays) {
                        row += "," + (data.relays.inside_1[index] ? "1" : "0");
                        row += "," + (data.relays.outside_1[index] ? "1" : "0");
                        row += "," + (data.relays.inside_2[index] ? "1" : "0");
                        row += "," + (data.relays.outside_2[index] ? "1" : "0");
                    } else {
                        row += ",,,,";
                    }
                    
                    csvContent += row + "\r\n";
                });
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "sensor_data.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
    }
</script>
{% endblock %}
{% extends "base.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<div class="row">
    <div class="col-md-12">
        <h1>Data Utilities</h1>
        <p class="text-muted">Visualize, analyze, and manage historical sensor data.</p>
        
        <!-- Grapher Card -->
        <div class="card mb-4">
            <div class="card-header">Grapher & Analysis</div>
            <div class="card-body">
                <form id="graph-form" class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label for="start-time" class="form-label">Start Time</label>
                        <input type="datetime-local" class="form-control" id="start-time" required>
                    </div>
                    <div class="col-md-2">
                        <label for="end-time" class="form-label">End Time</label>
                        <input type="datetime-local" class="form-control" id="end-time" required>
                    </div>
                    <div class="col-md-2">
                        <label for="smoothing" class="form-label">Smoothing (pts)</label>
                        <input type="number" class="form-control" id="smoothing" value="1" min="1" max="100">
                    </div>
                    <div class="col-md-2">
                        <label for="downsample" class="form-label">Downsample (factor)</label>
                        <input type="number" class="form-control" id="downsample" value="1" min="1" max="1000" title="Plot every Nth point">
                    </div>
                    <div class="col-md-2">
                        <label for="highlight" class="form-label">Highlight</label>
                        <select class="form-select" id="highlight">
                            <option value="none" selected>None</option>
                            <option value="circuit1">Circuit 1</option>
                            <option value="circuit2">Circuit 2</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="filter-state" class="form-label">Filter State</label>
                        <select class="form-select" id="filter-state">
                            <option value="none" selected>All Data</option>
                            <option value="c1_on">Circuit 1 ON</option>
                            <option value="c1_off">Circuit 1 OFF</option>
                            <option value="c2_on">Circuit 2 ON</option>
                            <option value="c2_off">Circuit 2 OFF</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Data Selection</label>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="sensorDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                Select Data
                            </button>
                            <ul class="dropdown-menu w-100" aria-labelledby="sensorDropdown" id="sensor-list">
                                <!-- Populated by JS -->
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-primary w-100">Graph</button>
                    </div>
                </form>

                <!-- Derived Columns -->
                <div class="mt-4">
                    <h5>Derived Columns</h5>
                    <p class="text-muted small">
                        Define custom columns using expressions. Supported: <code>+ - * / ( )</code>, <code>sin, cos, sqrt, abs, power</code>. 
                        Special functions: <code>integrate(col)</code> (cumulative sum), <code>diff(col)</code> (difference).
                        Example: <code>p1 = v1 * i1</code> or <code>e1 = integrate(v1 * i1)</code>.
                    </p>
                    <div id="derived-cols-container">
                        <!-- Rows go here -->
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addDerivedColumnRow()">+ Add Derived Column</button>
                </div>
            </div>
        </div>

        <!-- Chart Card -->
        <div class="card mb-4">
            <div class="card-body">
                <div style="height: 500px;">
                    <canvas id="main-chart"></canvas>
                </div>
                <div class="mt-3 text-end">
                    <button class="btn btn-success" onclick="exportCSV()">Export CSV</button>
                </div>
            </div>
        </div>

        <!-- Database Utilities Card -->
        <div class="card border-danger mb-4">
            <div class="card-header bg-danger text-white">Database Utilities</div>
            <div class="card-body">
                <h5>Downsample Database</h5>
                <p>Permanently reduce database size by keeping only 1 out of every N rows. <strong>This cannot be undone.</strong></p>
                <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#downsampleModal">Downsample Database...</button>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="downsampleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Downsample Database</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>This will permanently delete data. Are you sure?</p>
                <div class="mb-3">
                    <label class="form-label">Keep 1 row every N rows:</label>
                    <input type="number" class="form-control" id="db-downsample-factor" value="2" min="2">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#downsampleConfirmModal" data-bs-dismiss="modal">Proceed</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="downsampleConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>This action is irreversible. Type <strong>DELETE</strong> to confirm.</p>
                <input type="text" class="form-control" id="delete-confirm-input">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="executeDBDownsample()" id="btn-confirm-delete" disabled>Permanently Downsample</button>
            </div>
        </div>
    </div>
</div>

<script>
    let mainChart;
    let availableSensors = [];

    // Plugin to draw background highlights
    const backgroundPlugin = {
        id: 'backgroundPlugin',
        beforeDraw: (chart) => {
            const highlightMode = document.getElementById('highlight').value;
            if (highlightMode === 'none' || !chart.data.relays) return;

            const ctx = chart.ctx;
            const xAxis = chart.scales.x;
            const yAxis = chart.scales.y;
            const relays = chart.data.relays;
            
            let relayInside, relayOutside;
            if (highlightMode === 'circuit1') {
                relayInside = relays.inside_1;
                relayOutside = relays.outside_1;
            } else {
                relayInside = relays.inside_2;
                relayOutside = relays.outside_2;
            }

            ctx.save();
            
            for (let i = 0; i < relayInside.length - 1; i++) {
                const isOn = relayInside[i] && relayOutside[i];
                ctx.fillStyle = isOn ? 'rgba(25, 135, 84, 0.15)' : 'rgba(220, 53, 69, 0.15)';
                const startX = xAxis.getPixelForValue(chart.data.labels[i]);
                const endX = xAxis.getPixelForValue(chart.data.labels[i+1]);
                ctx.fillRect(startX, yAxis.top, endX - startX, yAxis.bottom - yAxis.top);
            }
            
            ctx.restore();
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        // Set default times
        const now = new Date();
        const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
        
        const formatDT = (d) => {
            const pad = (n) => n < 10 ? '0' + n : n;
            return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
        };
        
        document.getElementById('end-time').value = formatDT(now);
        document.getElementById('start-time').value = formatDT(yesterday);

        // Load sensors
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                availableSensors = Object.keys(data.sensors).sort();
                updateSensorList();
                updateGraph();
            });

        document.getElementById('graph-form').addEventListener('submit', (e) => {
            e.preventDefault();
            updateGraph();
        });
        
        // Confirm delete input handler
        document.getElementById('delete-confirm-input').addEventListener('input', (e) => {
            document.getElementById('btn-confirm-delete').disabled = e.target.value !== 'DELETE';
        });
    });
    
    function updateSensorList() {
        const list = document.getElementById('sensor-list');
        list.innerHTML = '';
        
        // Add Deselect All button
        const btnLi = document.createElement('li');
        btnLi.innerHTML = `
            <div class="dropdown-item">
                <button type="button" class="btn btn-sm btn-outline-secondary w-100" onclick="deselectAllSensors(event)">Deselect All</button>
            </div>
        `;
        list.appendChild(btnLi);

        const dividerLi = document.createElement('li');
        dividerLi.innerHTML = '<hr class="dropdown-divider">';
        list.appendChild(dividerLi);
        
        // Native sensors
        availableSensors.forEach(s => {
            addSensorCheckbox(list, s, s, true);
        });
        
        // Derived sensors (from inputs)
        const derived = getDerivedDefinitions();
        derived.forEach(d => {
            addSensorCheckbox(list, d.name, `${d.name} (Derived)`, true);
        });
    }
    
    function deselectAllSensors(event) {
        if (event) event.stopPropagation();
        document.querySelectorAll('.sensor-check').forEach(cb => cb.checked = false);
    }
    
    function addSensorCheckbox(list, value, label, checked) {
        const li = document.createElement('li');
        li.innerHTML = `
            <div class="dropdown-item">
                <div class="form-check">
                    <input class="form-check-input sensor-check" type="checkbox" value="${value}" id="check-${value}" ${checked ? 'checked' : ''}>
                    <label class="form-check-label" for="check-${value}">
                        ${label}
                    </label>
                </div>
            </div>
        `;
        list.appendChild(li);
    }

    function addDerivedColumnRow() {
        const container = document.getElementById('derived-cols-container');
        const div = document.createElement('div');
        div.className = 'row g-2 mb-2 derived-row';
        div.innerHTML = `
            <div class="col-md-3">
                <input type="text" class="form-control derived-name" placeholder="Name (e.g. p1)" onchange="updateSensorList()">
            </div>
            <div class="col-md-7">
                <input type="text" class="form-control derived-expr" placeholder="Expression (e.g. v1 * i1)">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-outline-danger w-100" onclick="this.closest('.derived-row').remove(); updateSensorList()">Remove</button>
            </div>
        `;
        container.appendChild(div);
    }
    
    function getDerivedDefinitions() {
        const rows = document.querySelectorAll('.derived-row');
        const defs = [];
        rows.forEach(row => {
            const name = row.querySelector('.derived-name').value.trim();
            const expr = row.querySelector('.derived-expr').value.trim();
            if (name && expr) {
                defs.push({name, expr});
            }
        });
        return defs;
    }

    function updateGraph() {
        const start = new Date(document.getElementById('start-time').value).toISOString();
        const end = new Date(document.getElementById('end-time').value).toISOString();
        const smoothing = parseInt(document.getElementById('smoothing').value) || 1;
        const downsample = parseInt(document.getElementById('downsample').value) || 1;
        const filterState = document.getElementById('filter-state').value;
        
        const selectedSensors = Array.from(document.querySelectorAll('.sensor-check:checked')).map(cb => cb.value);
        const derivedDefs = getDerivedDefinitions();
        
        if (selectedSensors.length === 0) {
            alert("Please select at least one data column.");
            return;
        }

        const params = new URLSearchParams({
            start: start,
            end: end,
            sensors: selectedSensors.join(','),
            derived_defs: JSON.stringify(derivedDefs),
            downsample_factor: downsample,
            filter_state: filterState
        });

        fetch(`/api/history?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('main-chart');
                const timestamps = data.timestamps.map(t => new Date(t));
                
                const datasets = Object.entries(data.sensors).map(([sensor, values], index) => {
                    // Apply smoothing
                    let smoothedValues = values;
                    if (smoothing > 1) {
                        smoothedValues = [];
                        for (let i = 0; i < values.length; i++) {
                            let sum = 0;
                            let count = 0;
                            for (let j = 0; j < smoothing; j++) {
                                if (i - j >= 0 && values[i - j] !== null) {
                                    sum += values[i - j];
                                    count++;
                                }
                            }
                            smoothedValues.push(count > 0 ? sum / count : null);
                        }
                    }

                    const colors = [
                        'rgb(255, 99, 132)', 'rgb(54, 162, 235)', 'rgb(255, 206, 86)', 
                        'rgb(75, 192, 192)', 'rgb(153, 102, 255)', 'rgb(255, 159, 64)',
                        'rgb(199, 199, 199)'
                    ];
                    
                    const label = data.sensor_names && data.sensor_names[sensor] ? data.sensor_names[sensor] : sensor;

                    return {
                        label: label,
                        data: smoothedValues,
                        borderColor: colors[index % colors.length],
                        tension: 0.1,
                        pointRadius: 0,
                        borderWidth: 2
                    };
                });

                if (mainChart) {
                    mainChart.destroy();
                }

                mainChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: timestamps,
                        datasets: datasets
                    },
                    plugins: [backgroundPlugin],
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: 'Data History' }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                min: new Date(start),
                                max: new Date(end),
                                time: {
                                    displayFormats: {
                                        minute: 'HH:mm',
                                        hour: 'MM/dd HH:mm'
                                    }
                                }
                            }
                        }
                    }
                });
                
                mainChart.data.relays = data.relays;
                mainChart.update();
            });
    }

    function exportCSV() {
        const start = new Date(document.getElementById('start-time').value).toISOString();
        const end = new Date(document.getElementById('end-time').value).toISOString();
        const downsample = parseInt(document.getElementById('downsample').value) || 1;
        const filterState = document.getElementById('filter-state').value;
        const selectedSensors = Array.from(document.querySelectorAll('.sensor-check:checked')).map(cb => cb.value);
        const derivedDefs = getDerivedDefinitions();
        
        if (selectedSensors.length === 0) {
            alert("Please select at least one data column.");
            return;
        }

        const params = new URLSearchParams({
            start: start,
            end: end,
            sensors: selectedSensors.join(','),
            derived_defs: JSON.stringify(derivedDefs),
            downsample_factor: downsample,
            filter_state: filterState
        });

        fetch(`/api/history?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Timestamp," + Object.keys(data.sensors).join(",") + ",Relay_In_1,Relay_Out_1,Relay_In_2,Relay_Out_2\r\n";
                
                data.timestamps.forEach((ts, index) => {
                    let row = ts;
                    Object.values(data.sensors).forEach(values => {
                        row += "," + (values[index] !== null ? values[index] : "");
                    });
                    
                    if (data.relays) {
                        row += "," + (data.relays.inside_1[index] ? "1" : "0");
                        row += "," + (data.relays.outside_1[index] ? "1" : "0");
                        row += "," + (data.relays.inside_2[index] ? "1" : "0");
                        row += "," + (data.relays.outside_2[index] ? "1" : "0");
                    } else {
                        row += ",,,,";
                    }
                    csvContent += row + "\r\n";
                });
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "data_export.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
    }
    
    function executeDBDownsample() {
        const factor = document.getElementById('db-downsample-factor').value;
        fetch('/api/maintenance/downsample_db', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ factor: factor })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Database downsampled successfully.");
                location.reload();
            } else {
                alert("Error: " + data.message);
            }
        });
    }
</script>
{% endblock %}
{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1>System Controls</h1>
        <p class="text-muted">Modify system parameters. Changes take effect immediately.</p>
        
        <div id="alert-box"></div>

        <!-- GFCI Control Card -->
        <div class="card mb-4 border-danger">
            <div class="card-header bg-danger text-white">
                GFCI Control
            </div>
            <div class="card-body">
                <div id="gfci-error-msg" class="alert alert-warning py-2" style="display: none;"></div>
                <div class="row">
                    <div class="col-md-4">
                        <h5>Circuit Status</h5>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Circuit 1:</span>
                            <span id="gfci-c1-status" class="badge bg-secondary">Unknown</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Circuit 2:</span>
                            <span id="gfci-c2-status" class="badge bg-secondary">Unknown</span>
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-sm btn-danger" onclick="gfciHardReset()">Hard Reset Nano (GPIO)</button>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <h5>UART Shell</h5>
                        <textarea id="gfci-shell-output" class="form-control mb-2" rows="8" readonly style="font-family: monospace; background-color: #f8f9fa; font-size: 0.9em;"></textarea>
                        <div class="input-group">
                            <input type="text" id="gfci-shell-input" class="form-control" placeholder="Enter command (e.g., HLP)" onkeypress="handleShellEnter(event)">
                            <button class="btn btn-primary" type="button" onclick="sendShellCommand()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hardware Maintenance Card -->
        <div class="card mb-4 border-warning">
            <div class="card-header bg-warning text-dark">
                Hardware Maintenance
            </div>
            <div class="card-body">
                <p class="card-text">Use these controls to recover from hardware communication errors.</p>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-dark" onclick="resetArduino()">
                        <i class="bi bi-cpu"></i> Force Reset Arduino
                    </button>
                    <button class="btn btn-outline-danger" onclick="reinitHardware()">
                        <i class="bi bi-arrow-repeat"></i> Force Re-init Hardware
                    </button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <form id="config-form">
                    <div id="config-fields">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="card mt-4">
            <div class="card-header">
                Current Light Window ({{ timezone }})
            </div>
            <div class="card-body">
                <p>Based on current location and offsets:</p>
                <ul>
                    <li><strong>Start (Sunrise + Offset):</strong> {{ window[0].strftime('%Y-%m-%d %H:%M:%S') }}</li>
                    <li><strong>End (Sunset - Offset):</strong> {{ window[1].strftime('%Y-%m-%d %H:%M:%S') }}</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    const categoryOrder = {{ categories | tojson }};

    document.addEventListener('DOMContentLoaded', () => {
        loadConfig();
        updateGfciStatus();
        setInterval(updateGfciStatus, 2000);
        // Initial Help Command
        setTimeout(() => sendShellCommand('HLP'), 500);
    });

    function handleShellEnter(e) {
        if(e.key === 'Enter') sendShellCommand();
    }

    function sendShellCommand(cmdOverride) {
        const input = document.getElementById('gfci-shell-input');
        const output = document.getElementById('gfci-shell-output');
        const cmd = cmdOverride || input.value;
        
        if(!cmd) return;
        
        output.value += `> ${cmd}\n`;
        output.scrollTop = output.scrollHeight;
        if(!cmdOverride) input.value = '';

        fetch('/api/gfci/command', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({command: cmd})
        })
        .then(r => r.json())
        .then(d => {
            if(d.status === 'ok') {
                output.value += `${d.response}\n`;
            } else {
                output.value += `Error: ${d.message}\n`;
            }
            output.scrollTop = output.scrollHeight;
        })
        .catch(err => {
            output.value += `Network Error: ${err}\n`;
            output.scrollTop = output.scrollHeight;
        });
    }

    function gfciHardReset() {
        if(!confirm('Are you sure you want to HARD reset the GFCI Nano? This toggles the GPIO.')) return;
        fetch('/api/gfci/reset/hard', { method: 'POST' })
            .then(r => r.json())
            .then(d => {
                if(d.status === 'ok') {
                    showAlert('Hard reset performed', 'success');
                    const output = document.getElementById('gfci-shell-output');
                    output.value += `> [HARD RESET]\n`;
                }
                else showAlert('Error: ' + d.message, 'danger');
            });
    }
    
    function updateGfciStatus() {
        fetch('/api/status')
            .then(r => r.json())
            .then(data => {
                if(data.gfci_status) {
                    const s = data.gfci_status;
                    const c1 = document.getElementById('gfci-c1-status');
                    const c2 = document.getElementById('gfci-c2-status');
                    const errDiv = document.getElementById('gfci-error-msg');
                    const shellInput = document.getElementById('gfci-shell-input');
                    const shellOutput = document.getElementById('gfci-shell-output');
                    const hardResetBtn = document.querySelector('button[onclick="gfciHardReset()"]');

                    if (!s.enabled) {
                        if(c1) { c1.textContent = 'DISABLED'; c1.className = 'badge bg-secondary'; }
                        if(c2) { c2.textContent = 'DISABLED'; c2.className = 'badge bg-secondary'; }
                        if(errDiv) {
                            errDiv.textContent = 'GFCI System Disabled in Configuration';
                            errDiv.style.display = 'block';
                            errDiv.className = 'alert alert-secondary py-2';
                        }
                        if(shellInput) shellInput.disabled = true;
                        if(shellOutput) {
                            shellOutput.disabled = true;
                            shellOutput.style.backgroundColor = '#e9ecef';
                        }
                        if(hardResetBtn) hardResetBtn.disabled = true;
                        return;
                    } else {
                        if(shellInput) shellInput.disabled = false;
                        if(shellOutput) {
                            shellOutput.disabled = false;
                            shellOutput.style.backgroundColor = '#f8f9fa';
                        }
                        if(hardResetBtn) hardResetBtn.disabled = false;
                        if(errDiv && errDiv.textContent === 'GFCI System Disabled in Configuration') {
                            errDiv.style.display = 'none';
                            errDiv.className = 'alert alert-warning py-2';
                        }
                    }
                    
                    if (s.error) {
                        if(c1) { c1.textContent = 'ERROR'; c1.className = 'badge bg-warning text-dark'; }
                        if(c2) { c2.textContent = 'ERROR'; c2.className = 'badge bg-warning text-dark'; }
                        if(errDiv) {
                            errDiv.textContent = 'Communication Error: ' + s.error;
                            errDiv.style.display = 'block';
                        }
                    } else {
                        if(c1) {
                            c1.textContent = s.tripped[0] ? 'TRIPPED' : 'OK';
                            c1.className = s.tripped[0] ? 'badge bg-danger' : 'badge bg-success';
                        }
                        
                        if(c2) {
                            c2.textContent = s.tripped[1] ? 'TRIPPED' : 'OK';
                            c2.className = s.tripped[1] ? 'badge bg-danger' : 'badge bg-success';
                        }
                        
                        if(errDiv) errDiv.style.display = 'none';
                        
                        // Only update threshold input if not focused
                        const threshInput = document.getElementById('gfci-threshold');
                        if(threshInput && document.activeElement !== threshInput) {
                            threshInput.value = s.threshold;
                        }
                    }
                }
            });
    }

    function loadConfig() {
        fetch('/api/config')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('config-fields');
                container.innerHTML = ''; // Clear loading spinner

                // Group by category
                const categories = {};
                Object.keys(data).forEach(key => {
                    const item = data[key];
                    const cat = item.category || 'Other';
                    if (!categories[cat]) categories[cat] = [];
                    categories[cat].push({ key, ...item });
                });

                // Sort categories based on Enum order
                const sortedCats = Object.keys(categories).sort((a, b) => {
                    const idxA = categoryOrder.indexOf(a);
                    const idxB = categoryOrder.indexOf(b);
                    
                    // If both are in the list, sort by index
                    if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                    
                    // If only A is in the list, it comes first
                    if (idxA !== -1) return -1;
                    
                    // If only B is in the list, it comes first
                    if (idxB !== -1) return 1;
                    
                    // Otherwise sort alphabetically
                    return a.localeCompare(b);
                });

                sortedCats.forEach(catName => {
                    // Create Category Header
                    const catHeader = document.createElement('h4');
                    catHeader.className = 'mt-4 mb-3 border-bottom pb-2 text-primary';
                    catHeader.textContent = catName;
                    container.appendChild(catHeader);

                    // Sort items within category
                    categories[catName].sort((a, b) => a.key.localeCompare(b.key));

                    categories[catName].forEach(item => {
                        const key = item.key;
                        const formGroup = document.createElement('div');
                        formGroup.className = 'mb-3 row';

                        const label = document.createElement('label');
                        label.className = 'col-sm-4 col-form-label';
                        label.htmlFor = `input-${key}`;
                        label.innerHTML = `<strong>${key}</strong><br><small class="text-muted">${item.description}</small>`;

                        const divInput = document.createElement('div');
                        divInput.className = 'col-sm-6';

                        let input;
                        let getValue;

                        if (item.value_type === 'boolean') {
                            const wrapper = document.createElement('div');
                            wrapper.className = 'form-check form-switch pt-2';
                            
                            input = document.createElement('input');
                            input.className = 'form-check-input';
                            input.type = 'checkbox';
                            input.id = `input-${key}`;
                            input.checked = item.value === true; // Ensure strict boolean check
                            
                            // Make the switch larger to match other inputs better
                            input.style.fontSize = '1.4rem'; 
                            input.style.cursor = 'pointer';

                            wrapper.appendChild(input);
                            divInput.appendChild(wrapper);
                            
                            getValue = () => input.checked;
                        } else if (item.value_type === 'number') {
                            input = document.createElement('input');
                            input.type = 'number';
                            input.step = 'any';
                            input.className = 'form-control';
                            input.id = `input-${key}`;
                            input.value = item.value;
                            divInput.appendChild(input);
                            
                            getValue = () => parseFloat(input.value);
                        } else {
                            input = document.createElement('input');
                            input.type = 'text';
                            input.className = 'form-control';
                            input.id = `input-${key}`;
                            
                            // Handle array/eval types
                            // The API now returns the raw string for eval types, so we don't need to stringify objects
                            let displayValue = item.value;
                            if (typeof displayValue === 'object' && displayValue !== null) {
                                // Fallback just in case
                                displayValue = JSON.stringify(displayValue);
                            }
                            input.value = displayValue;
                            divInput.appendChild(input);
                            
                            getValue = () => input.value;
                        }

                        const divBtn = document.createElement('div');
                        divBtn.className = 'col-sm-2';
                        
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-primary w-100';
                        btn.textContent = 'Save';
                        btn.type = 'button';
                        btn.onclick = () => saveConfig(key, getValue());

                        divBtn.appendChild(btn);
                        
                        formGroup.appendChild(label);
                        formGroup.appendChild(divInput);
                        formGroup.appendChild(divBtn);

                        container.appendChild(formGroup);
                        container.appendChild(document.createElement('hr'));
                    });
                });
            })
            .catch(err => {
                console.error('Error loading config:', err);
                document.getElementById('config-fields').innerHTML = '<div class="alert alert-danger">Failed to load configuration.</div>';
            });
    }

    function resetArduino() {
        if (!confirm("Are you sure you want to reset the Arduino? This may interrupt control loops.")) return;
        
        fetch('/api/maintenance/reset_arduino', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Arduino reset command sent successfully.");
                } else {
                    alert("Error resetting Arduino: " + data.message);
                }
            })
            .catch(err => alert("Request failed: " + err));
    }

    function reinitHardware() {
        if (!confirm("Are you sure you want to re-initialize all hardware? This will stop and restart all drivers.")) return;

        fetch('/api/maintenance/reinit_hardware', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Hardware re-initialization complete.");
                } else {
                    alert("Error re-initializing hardware: " + data.message);
                }
            })
            .catch(err => alert("Request failed: " + err));
    }

    function showAlert(message, type) {
        const alertBox = document.getElementById('alert-box');
        if(alertBox) {
            alertBox.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
        } else {
            alert(message);
        }
    }

    function saveConfig(key, value) {
        fetch('/api/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                key: key,
                value: value
            }),
        })
        .then(response => response.json())
        .then(data => {
            const alertBox = document.getElementById('alert-box');
            if (data.success) {
                alertBox.innerHTML = `<div class="alert alert-success alert-dismissible fade show" role="alert">
                    Saved <strong>${key}</strong> successfully.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            } else {
                alertBox.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
                    Error saving <strong>${key}</strong>: ${data.error || 'Unknown error'}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            }
        })
        .catch(err => {
            console.error('Error saving config:', err);
            alert('Failed to save configuration.');
        });
    }
</script>
{% endblock %}
